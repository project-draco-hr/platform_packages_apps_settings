{
  String enabledServicesSetting=Settings.Secure.getString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES);
  if (enabledServicesSetting == null) {
    enabledServicesSetting="";
  }
  Set<ComponentName> enabledServices=sEnabledServices;
  enabledServices.clear();
  SimpleStringSplitter colonSplitter=sStringColonSplitter;
  colonSplitter.setString(enabledServicesSetting);
  while (colonSplitter.hasNext()) {
    String componentNameString=colonSplitter.next();
    ComponentName enabledService=ComponentName.unflattenFromString(componentNameString);
    if (enabledService != null) {
      enabledServices.add(enabledService);
    }
  }
  ComponentName toggledService=ComponentName.unflattenFromString(preferenceKey);
  final boolean accessibilityEnabled;
  if (enabled) {
    accessibilityEnabled=true;
    enabledServices.add(toggledService);
  }
 else {
    int enabledAndInstalledServiceCount=0;
    Set<ComponentName> installedServices=sInstalledServices;
    for (    ComponentName enabledService : enabledServices) {
      if (installedServices.contains(enabledService)) {
        enabledAndInstalledServiceCount++;
      }
    }
    accessibilityEnabled=enabledAndInstalledServiceCount > 1 || (enabledAndInstalledServiceCount == 1 && !installedServices.contains(toggledService));
    enabledServices.remove(toggledService);
  }
  StringBuilder enabledServicesBuilder=new StringBuilder();
  for (  ComponentName enabledService : enabledServices) {
    enabledServicesBuilder.append(enabledService.flattenToString());
    enabledServicesBuilder.append(ENABLED_ACCESSIBILITY_SERVICES_SEPARATOR);
  }
  final int enabledServicesBuilderLength=enabledServicesBuilder.length();
  if (enabledServicesBuilderLength > 0) {
    enabledServicesBuilder.deleteCharAt(enabledServicesBuilderLength - 1);
  }
  Settings.Secure.putString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,enabledServicesBuilder.toString());
  Settings.Secure.putInt(getContentResolver(),Settings.Secure.ACCESSIBILITY_ENABLED,accessibilityEnabled ? 1 : 0);
}
