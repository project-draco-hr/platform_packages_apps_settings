{
  String enabledServices=Settings.Secure.getString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES);
  if (enabledServices == null) {
    enabledServices="";
  }
  if (enabledServices.endsWith(ENABLED_ACCESSIBILITY_SERVICES_SEPARATOR)) {
    enabledServices=enabledServices.substring(0,enabledServices.length() - 1);
  }
  final int length=enabledServices.length();
  if (enabled) {
    if (enabledServices.contains(preferenceKey)) {
      return;
    }
    if (length == 0) {
      enabledServices+=preferenceKey;
      Settings.Secure.putString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,enabledServices);
      Settings.Secure.putInt(getContentResolver(),Settings.Secure.ACCESSIBILITY_ENABLED,1);
    }
 else     if (length > 0) {
      enabledServices+=ENABLED_ACCESSIBILITY_SERVICES_SEPARATOR + preferenceKey;
      Settings.Secure.putString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,enabledServices);
    }
  }
 else {
    final int index=enabledServices.indexOf(preferenceKey);
    if (index == 0) {
      enabledServices=enabledServices.replace(preferenceKey,"");
      Settings.Secure.putString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,enabledServices);
      Settings.Secure.putInt(getContentResolver(),Settings.Secure.ACCESSIBILITY_ENABLED,0);
    }
 else     if (index > 0) {
      enabledServices=enabledServices.replace(ENABLED_ACCESSIBILITY_SERVICES_SEPARATOR + preferenceKey,"");
      Settings.Secure.putString(getContentResolver(),Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,enabledServices);
    }
  }
}
