{
  AccessibilityManager accessibilityManager=(AccessibilityManager)getSystemService(Service.ACCESSIBILITY_SERVICE);
  List<AccessibilityServiceInfo> installedServices=accessibilityManager.getInstalledAccessibilityServiceList();
  for (int i=0; i < mAccessibilityServicesCategory.getPreferenceCount(); i++) {
    Preference pref=mAccessibilityServicesCategory.getPreference(i);
    if (pref != mToggleAccessibilityCheckBox && pref != mToggleScriptInjectionCheckBox) {
      mAccessibilityServicesCategory.removePreference(pref);
      i--;
    }
  }
  for (int i=0, count=installedServices.size(); i < count; ++i) {
    AccessibilityServiceInfo accessibilityServiceInfo=installedServices.get(i);
    String key=accessibilityServiceInfo.getId();
    if (mAccessibilityServices.put(key,accessibilityServiceInfo) == null) {
      String settingsActivityName=accessibilityServiceInfo.getSettingsActivityName();
      Intent settingsIntent=null;
      if (!TextUtils.isEmpty(settingsActivityName)) {
        String packageName=accessibilityServiceInfo.getResolveInfo().serviceInfo.packageName;
        settingsIntent=new Intent(Intent.ACTION_MAIN);
        settingsIntent.setClassName(packageName,settingsActivityName);
      }
      SettingsCheckBoxPreference preference=new SettingsCheckBoxPreference(getActivity(),settingsIntent);
      preference.setKey(key);
      preference.setOrder(i);
      ServiceInfo serviceInfo=accessibilityServiceInfo.getResolveInfo().serviceInfo;
      preference.setTitle(serviceInfo.loadLabel(getActivity().getPackageManager()));
      mAccessibilityServicesCategory.addPreference(preference);
    }
  }
}
