{
  final String pin=mPasswordEntry.getText().toString();
  if (TextUtils.isEmpty(pin)) {
    return;
  }
  String errorMsg=null;
  if (mUiStage == Stage.Introduction) {
    errorMsg=validatePassword(pin);
    if (errorMsg == null) {
      mFirstPin=pin;
      updateStage(Stage.NeedToConfirm);
      mPasswordEntry.setText("");
    }
  }
 else   if (mUiStage == Stage.NeedToConfirm) {
    if (mFirstPin.equals(pin)) {
      mLockPatternUtils.clearLock();
      final boolean isFallback=getActivity().getIntent().getBooleanExtra(LockPatternUtils.LOCKSCREEN_BIOMETRIC_WEAK_FALLBACK,false);
      mLockPatternUtils.saveLockPassword(pin,mRequestedQuality,isFallback);
      getActivity().finish();
    }
 else {
      updateStage(Stage.ConfirmWrong);
      CharSequence tmp=mPasswordEntry.getText();
      if (tmp != null) {
        Selection.setSelection((Spannable)tmp,0,tmp.length());
      }
    }
  }
  if (errorMsg != null) {
    showError(errorMsg,mUiStage);
  }
}
