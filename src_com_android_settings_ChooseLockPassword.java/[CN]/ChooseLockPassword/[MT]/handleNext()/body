{
  if (mDone)   return;
  final String pin=mPasswordEntry.getText().toString();
  if (TextUtils.isEmpty(pin)) {
    return;
  }
  String errorMsg=null;
  if (mUiStage == Stage.Introduction) {
    errorMsg=validatePassword(pin);
    if (errorMsg == null) {
      mFirstPin=pin;
      mPasswordEntry.setText("");
      updateStage(Stage.NeedToConfirm);
    }
  }
 else   if (mUiStage == Stage.NeedToConfirm) {
    if (mFirstPin.equals(pin)) {
      boolean wasSecureBefore=mLockPatternUtils.isSecure(UserHandle.myUserId());
      final boolean required=getActivity().getIntent().getBooleanExtra(EncryptionInterstitial.EXTRA_REQUIRE_PASSWORD,true);
      mLockPatternUtils.setCredentialRequiredToDecrypt(required);
      mLockPatternUtils.saveLockPassword(pin,mCurrentPassword,mRequestedQuality,UserHandle.myUserId());
      if (mHasChallenge) {
        startVerifyPassword(pin,wasSecureBefore);
        return;
      }
 else {
        getActivity().setResult(RESULT_FINISHED);
      }
      finishConfirmStage(wasSecureBefore);
    }
 else {
      CharSequence tmp=mPasswordEntry.getText();
      if (tmp != null) {
        Selection.setSelection((Spannable)tmp,0,tmp.length());
      }
      updateStage(Stage.ConfirmWrong);
    }
  }
  if (errorMsg != null) {
    showError(errorMsg,mUiStage);
  }
}
