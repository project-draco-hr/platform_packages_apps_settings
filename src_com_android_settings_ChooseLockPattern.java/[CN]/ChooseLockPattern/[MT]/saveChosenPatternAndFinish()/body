{
  if (mDone)   return;
  LockPatternUtils utils=mChooseLockSettingsHelper.utils();
  final boolean lockVirgin=!utils.isPatternEverChosen(UserHandle.myUserId());
  boolean wasSecureBefore=utils.isSecure(UserHandle.myUserId());
  final boolean required=getActivity().getIntent().getBooleanExtra(EncryptionInterstitial.EXTRA_REQUIRE_PASSWORD,true);
  utils.setCredentialRequiredToDecrypt(required);
  utils.saveLockPattern(mChosenPattern,mCurrentPattern,UserHandle.myUserId());
  if (lockVirgin) {
    utils.setVisiblePatternEnabled(true,UserHandle.myUserId());
  }
  if (mHasChallenge) {
    startVerifyPattern(utils,wasSecureBefore);
  }
 else {
    if (!wasSecureBefore) {
      startActivity(getRedactionInterstitialIntent(getActivity()));
    }
    getActivity().setResult(RESULT_FINISHED);
    doFinish();
  }
}
