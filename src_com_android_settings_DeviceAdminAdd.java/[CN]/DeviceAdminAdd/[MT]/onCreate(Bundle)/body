{
  super.onCreate(icicle);
  mHandler=new Handler(getMainLooper());
  mDPM=(DevicePolicyManager)getSystemService(Context.DEVICE_POLICY_SERVICE);
  if ((getIntent().getFlags() & Intent.FLAG_ACTIVITY_NEW_TASK) != 0) {
    Log.w(TAG,"Cannot start ADD_DEVICE_ADMIN as a new task");
    finish();
    return;
  }
  ComponentName cn=(ComponentName)getIntent().getParcelableExtra(DevicePolicyManager.EXTRA_DEVICE_ADMIN);
  if (cn == null) {
    Log.w(TAG,"No component specified in " + getIntent().getAction());
    finish();
    return;
  }
  ActivityInfo ai;
  try {
    ai=getPackageManager().getReceiverInfo(cn,PackageManager.GET_META_DATA);
  }
 catch (  PackageManager.NameNotFoundException e) {
    Log.w(TAG,"Unable to retrieve device policy " + cn,e);
    finish();
    return;
  }
  List<ResolveInfo> avail=getPackageManager().queryBroadcastReceivers(new Intent(DeviceAdminReceiver.ACTION_DEVICE_ADMIN_ENABLED),PackageManager.GET_DISABLED_UNTIL_USED_COMPONENTS);
  int count=avail == null ? 0 : avail.size();
  boolean found=false;
  for (int i=0; i < count; i++) {
    ResolveInfo ri=avail.get(i);
    if (ai.packageName.equals(ri.activityInfo.packageName) && ai.name.equals(ri.activityInfo.name)) {
      try {
        ri.activityInfo=ai;
        DeviceAdminInfo dpi=new DeviceAdminInfo(this,ri);
        found=true;
      }
 catch (      XmlPullParserException e) {
        Log.w(TAG,"Bad " + ri.activityInfo,e);
      }
catch (      IOException e) {
        Log.w(TAG,"Bad " + ri.activityInfo,e);
      }
      break;
    }
  }
  if (!found) {
    Log.w(TAG,"Request to add invalid device admin: " + cn);
    finish();
    return;
  }
  ResolveInfo ri=new ResolveInfo();
  ri.activityInfo=ai;
  try {
    mDeviceAdmin=new DeviceAdminInfo(this,ri);
  }
 catch (  XmlPullParserException e) {
    Log.w(TAG,"Unable to retrieve device policy " + cn,e);
    finish();
    return;
  }
catch (  IOException e) {
    Log.w(TAG,"Unable to retrieve device policy " + cn,e);
    finish();
    return;
  }
  if (DevicePolicyManager.ACTION_ADD_DEVICE_ADMIN.equals(getIntent().getAction())) {
    mRefreshing=false;
    if (mDPM.isAdminActive(cn)) {
      ArrayList<DeviceAdminInfo.PolicyInfo> newPolicies=mDeviceAdmin.getUsedPolicies();
      for (int i=0; i < newPolicies.size(); i++) {
        DeviceAdminInfo.PolicyInfo pi=newPolicies.get(i);
        if (!mDPM.hasGrantedPolicy(cn,pi.ident)) {
          mRefreshing=true;
          break;
        }
      }
      if (!mRefreshing) {
        setResult(Activity.RESULT_OK);
        finish();
        return;
      }
    }
  }
  mAddMsgText=getIntent().getCharSequenceExtra(DevicePolicyManager.EXTRA_ADD_EXPLANATION);
  setContentView(R.layout.device_admin_add);
  mAdminIcon=(ImageView)findViewById(R.id.admin_icon);
  mAdminName=(TextView)findViewById(R.id.admin_name);
  mAdminDescription=(TextView)findViewById(R.id.admin_description);
  mAddMsg=(TextView)findViewById(R.id.add_msg);
  mAddMsgExpander=(ImageView)findViewById(R.id.add_msg_expander);
  mAddMsg.setOnClickListener(new View.OnClickListener(){
    public void onClick(    View v){
      toggleMessageEllipsis(v);
    }
  }
);
  toggleMessageEllipsis(mAddMsg);
  mAdminWarning=(TextView)findViewById(R.id.admin_warning);
  mAdminPolicies=(ViewGroup)findViewById(R.id.admin_policies);
  mCancelButton=(Button)findViewById(R.id.cancel_button);
  mCancelButton.setOnClickListener(new View.OnClickListener(){
    public void onClick(    View v){
      finish();
    }
  }
);
  mActionButton=(Button)findViewById(R.id.action_button);
  mActionButton.setOnClickListener(new View.OnClickListener(){
    public void onClick(    View v){
      if (mAdding) {
        try {
          mDPM.setActiveAdmin(mDeviceAdmin.getComponent(),mRefreshing);
          setResult(Activity.RESULT_OK);
        }
 catch (        RuntimeException e) {
          Log.w(TAG,"Exception trying to activate admin " + mDeviceAdmin.getComponent(),e);
          if (mDPM.isAdminActive(mDeviceAdmin.getComponent())) {
            setResult(Activity.RESULT_OK);
          }
        }
        finish();
      }
 else {
        try {
          ActivityManagerNative.getDefault().stopAppSwitches();
        }
 catch (        RemoteException e) {
        }
        mDPM.getRemoveWarning(mDeviceAdmin.getComponent(),new RemoteCallback(mHandler){
          @Override protected void onResult(          Bundle bundle){
            CharSequence msg=bundle != null ? bundle.getCharSequence(DeviceAdminReceiver.EXTRA_DISABLE_WARNING) : null;
            if (msg == null) {
              try {
                ActivityManagerNative.getDefault().resumeAppSwitches();
              }
 catch (              RemoteException e) {
              }
              mDPM.removeActiveAdmin(mDeviceAdmin.getComponent());
              finish();
            }
 else {
              Bundle args=new Bundle();
              args.putCharSequence(DeviceAdminReceiver.EXTRA_DISABLE_WARNING,msg);
              showDialog(DIALOG_WARNING,args);
            }
          }
        }
);
      }
    }
  }
);
}
