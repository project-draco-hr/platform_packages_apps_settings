{
  StringBuilder builder=new StringBuilder();
  StringBuilder disabledSysImes=new StringBuilder();
  int firstEnabled=-1;
  int N=mInputMethodProperties.size();
  for (int i=0; i < N; ++i) {
    final InputMethodInfo property=mInputMethodProperties.get(i);
    final String id=property.getId();
    CheckBoxPreference pref=(CheckBoxPreference)findPreference(id);
    boolean currentInputMethod=id.equals(mLastInputMethodId);
    boolean systemIme=isSystemIme(property);
    if (((N == 1 || systemIme) && !mHaveHardKeyboard) || (pref != null && pref.isChecked())) {
      if (builder.length() > 0)       builder.append(':');
      builder.append(id);
      if (firstEnabled < 0) {
        firstEnabled=i;
      }
    }
 else     if (currentInputMethod) {
      mLastInputMethodId=mLastTickedInputMethodId;
    }
    if (pref != null && !pref.isChecked() && systemIme && mHaveHardKeyboard) {
      if (disabledSysImes.length() > 0)       disabledSysImes.append(":");
      disabledSysImes.append(id);
    }
  }
  if (TextUtils.isEmpty(mLastInputMethodId)) {
    if (firstEnabled >= 0) {
      mLastInputMethodId=mInputMethodProperties.get(firstEnabled).getId();
    }
 else {
      mLastInputMethodId=null;
    }
  }
  Settings.Secure.putString(getContentResolver(),Settings.Secure.ENABLED_INPUT_METHODS,builder.toString());
  Settings.Secure.putString(getContentResolver(),Settings.Secure.DISABLED_SYSTEM_INPUT_METHODS,disabledSysImes.toString());
  Settings.Secure.putString(getContentResolver(),Settings.Secure.DEFAULT_INPUT_METHOD,mLastInputMethodId != null ? mLastInputMethodId : "");
}
