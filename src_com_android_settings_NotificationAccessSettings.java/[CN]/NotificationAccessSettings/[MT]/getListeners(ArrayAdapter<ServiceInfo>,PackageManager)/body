{
  int listeners=0;
  if (adapter != null) {
    adapter.clear();
  }
  final int user=ActivityManager.getCurrentUser();
  List<ResolveInfo> installedServices=pm.queryIntentServicesAsUser(new Intent(NotificationListenerService.SERVICE_INTERFACE),PackageManager.GET_SERVICES | PackageManager.GET_META_DATA,user);
  for (int i=0, count=installedServices.size(); i < count; i++) {
    ResolveInfo resolveInfo=installedServices.get(i);
    ServiceInfo info=resolveInfo.serviceInfo;
    if (!android.Manifest.permission.BIND_NOTIFICATION_LISTENER_SERVICE.equals(info.permission)) {
      Slog.w(TAG,"Skipping notification listener service " + info.packageName + "/"+ info.name+ ": it does not require the permission "+ android.Manifest.permission.BIND_NOTIFICATION_LISTENER_SERVICE);
      continue;
    }
    if (adapter != null) {
      adapter.add(info);
    }
    listeners++;
  }
  return listeners;
}
