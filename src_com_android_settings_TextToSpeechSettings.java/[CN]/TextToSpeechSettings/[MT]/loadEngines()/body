{
  mDefaultSynthPref=(ListPreference)findPreference(KEY_TTS_DEFAULT_SYNTH);
  Intent intent=new Intent("android.intent.action.START_TTS_ENGINE");
  ResolveInfo[] enginesArray=new ResolveInfo[0];
  PackageManager pm=getPackageManager();
  enginesArray=pm.queryIntentActivities(intent,0).toArray(enginesArray);
  ArrayList<CharSequence> entries=new ArrayList<CharSequence>();
  ArrayList<CharSequence> values=new ArrayList<CharSequence>();
  String enabledEngines="";
  for (int i=0; i < enginesArray.length; i++) {
    String pluginPackageName=enginesArray[i].activityInfo.packageName;
    if (pluginPackageName.equals(SYSTEM_TTS)) {
      entries.add(enginesArray[i].loadLabel(pm));
      values.add(pluginPackageName);
    }
 else {
      CheckBoxPreference pref=(CheckBoxPreference)findPreference(KEY_PLUGIN_ENABLED_PREFIX + pluginPackageName);
      if ((pref != null) && pref.isChecked()) {
        entries.add(enginesArray[i].loadLabel(pm));
        values.add(pluginPackageName);
        enabledEngines=enabledEngines + pluginPackageName + " ";
      }
    }
  }
  ContentResolver resolver=getContentResolver();
  Settings.Secure.putString(resolver,TTS_ENABLED_PLUGINS,enabledEngines);
  CharSequence entriesArray[]=new CharSequence[entries.size()];
  CharSequence valuesArray[]=new CharSequence[values.size()];
  mDefaultSynthPref.setEntries(entries.toArray(entriesArray));
  mDefaultSynthPref.setEntryValues(values.toArray(valuesArray));
  String selectedEngine=Settings.Secure.getString(getContentResolver(),TTS_DEFAULT_SYNTH);
  int selectedEngineIndex=mDefaultSynthPref.findIndexOfValue(selectedEngine);
  if (selectedEngineIndex == -1) {
    selectedEngineIndex=mDefaultSynthPref.findIndexOfValue(SYSTEM_TTS);
  }
  mDefaultSynthPref.setValueIndex(selectedEngineIndex);
}
