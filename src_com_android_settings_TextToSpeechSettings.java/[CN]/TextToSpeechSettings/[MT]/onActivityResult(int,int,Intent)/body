{
  if (requestCode == VOICE_DATA_INTEGRITY_CHECK) {
    if (data == null) {
      mEnableDemo=false;
      mVoicesMissing=false;
      updateWidgetState();
      return;
    }
    ArrayList<String> available=data.getStringArrayListExtra("TextToSpeech.Engine.EXTRA_AVAILABLE_VOICES");
    ArrayList<String> unavailable=data.getStringArrayListExtra("TextToSpeech.Engine.EXTRA_UNAVAILABLE_VOICES");
    if ((available == null) || (unavailable == null)) {
      mEnableDemo=false;
      mVoicesMissing=false;
      updateWidgetState();
      return;
    }
    if (available.size() > 0) {
      if (mTts == null) {
        mTts=new TextToSpeech(this,this);
      }
      ListPreference ttsLanguagePref=(ListPreference)findPreference("tts_default_lang");
      CharSequence[] entries=new CharSequence[available.size()];
      CharSequence[] entryValues=new CharSequence[available.size()];
      for (int i=0; i < available.size(); i++) {
        String[] langCountryVariant=available.get(i).split("-");
        Locale loc=null;
        if (langCountryVariant.length == 1) {
          loc=new Locale(langCountryVariant[0]);
        }
 else         if (langCountryVariant.length == 2) {
          loc=new Locale(langCountryVariant[0],langCountryVariant[1]);
        }
 else         if (langCountryVariant.length == 3) {
          loc=new Locale(langCountryVariant[0],langCountryVariant[1],langCountryVariant[2]);
        }
        if (loc != null) {
          entries[i]=loc.getDisplayName();
          entryValues[i]=available.get(i);
        }
      }
      ttsLanguagePref.setEntries(entries);
      ttsLanguagePref.setEntryValues(entryValues);
      mEnableDemo=true;
    }
 else {
      mEnableDemo=false;
    }
    if (unavailable.size() > 0) {
      mVoicesMissing=true;
    }
 else {
      mVoicesMissing=false;
    }
    updateWidgetState();
  }
 else   if (requestCode == GET_SAMPLE_TEXT) {
    if (resultCode == TextToSpeech.LANG_AVAILABLE) {
      String sample=getString(R.string.tts_demo);
      if ((data != null) && (data.getStringExtra("sampleText") != null)) {
        sample=data.getStringExtra("sampleText");
      }
      if (mTts != null) {
        mTts.speak(sample,TextToSpeech.QUEUE_FLUSH,null);
      }
    }
 else {
      Log.e(TAG,"Did not have a sample string for the requested language");
    }
  }
}
