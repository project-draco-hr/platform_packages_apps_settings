{
  final String packageName=preference.getKey();
  final PackageEntry pe=mPackageEntryMap.get(packageName);
  if (pe == null) {
    Log.w(TAG,"Preference change event for package " + packageName + " but that package is no longer valid.");
    return false;
  }
  if (!(newValue instanceof Boolean)) {
    Log.w(TAG,"Preference change event for package " + packageName + " had non boolean value of type "+ newValue.getClass().getName());
    return false;
  }
  final int newMode=(Boolean)newValue ? AppOpsManager.MODE_ALLOWED : AppOpsManager.MODE_IGNORED;
  if (pe.appOpMode != newMode) {
    if (newMode != AppOpsManager.MODE_ALLOWED) {
      setNewMode(pe,newMode);
      return true;
    }
    getFragmentManager().beginTransaction().add(new WarningDialog(pe),"warning").commit();
    return false;
  }
  return true;
}
