{
  final PreferenceScreen preferenceScreen=getPreferenceScreen();
  getActivity().invalidateOptionsMenu();
  int messageId=0;
switch (bluetoothState) {
case BluetoothAdapter.STATE_ON:
    preferenceScreen.removeAll();
  setFilter(BluetoothDeviceFilter.BONDED_DEVICE_FILTER);
setDeviceListGroup(preferenceScreen);
preferenceScreen.setOrderingAsAdded(true);
addCachedDevices();
int numberOfPairedDevices=preferenceScreen.getPreferenceCount();
mFoundDevicesCategory=new ProgressCategory(getActivity(),null);
mFoundDevicesCategory.setTitle(R.string.bluetooth_preference_found_devices);
preferenceScreen.addPreference(mFoundDevicesCategory);
mFoundDevicesCategoryIsPresent=true;
setFilter(BluetoothDeviceFilter.UNBONDED_DEVICE_FILTER);
setDeviceListGroup(mFoundDevicesCategory);
addCachedDevices();
int numberOfUnpairedDevices=mFoundDevicesCategory.getPreferenceCount();
if (numberOfUnpairedDevices == 0) {
preferenceScreen.removePreference(mFoundDevicesCategory);
mFoundDevicesCategoryIsPresent=false;
}
if (numberOfPairedDevices == 0) startScanning();
return;
case BluetoothAdapter.STATE_TURNING_OFF:
int preferenceCount=preferenceScreen.getPreferenceCount();
for (int i=0; i < preferenceCount; i++) {
preferenceScreen.getPreference(i).setEnabled(false);
}
return;
case BluetoothAdapter.STATE_OFF:
messageId=R.string.bluetooth_empty_list_bluetooth_off;
break;
case BluetoothAdapter.STATE_TURNING_ON:
messageId=R.string.bluetooth_turning_on;
break;
}
setDeviceListGroup(preferenceScreen);
removeAllDevices();
Preference emptyListPreference=new Preference(getActivity());
emptyListPreference.setTitle(messageId);
preferenceScreen.addPreference(emptyListPreference);
}
