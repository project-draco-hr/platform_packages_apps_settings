{
  BatteryInfo info=new BatteryInfo();
  info.mBatteryLevel=com.android.settings.Utils.getBatteryLevel(batteryBroadcast);
  String batteryPercentString=Utils.formatPercentage(info.mBatteryLevel);
  if (batteryBroadcast.getIntExtra(BatteryManager.EXTRA_PLUGGED,0) == 0) {
    final long drainTime=stats.computeBatteryTimeRemaining(elapsedRealtimeUs);
    if (drainTime > 0) {
      info.remainingTimeUs=drainTime;
      String timeString=Formatter.formatShortElapsedTime(context,drainTime / 1000);
      info.mChargeLabelString=context.getResources().getString(R.string.power_discharging_duration,batteryPercentString,timeString);
    }
 else {
      info.mChargeLabelString=batteryPercentString;
    }
  }
 else {
    final long chargeTime=stats.computeChargeTimeRemaining(elapsedRealtimeUs);
    final String statusLabel=com.android.settings.Utils.getBatteryStatus(context.getResources(),batteryBroadcast);
    final int status=batteryBroadcast.getIntExtra(BatteryManager.EXTRA_STATUS,BatteryManager.BATTERY_STATUS_UNKNOWN);
    if (chargeTime > 0 && status != BatteryManager.BATTERY_STATUS_FULL) {
      info.mDischarging=false;
      info.remainingTimeUs=chargeTime;
      String timeString=Formatter.formatShortElapsedTime(context,chargeTime / 1000);
      int plugType=batteryBroadcast.getIntExtra(BatteryManager.EXTRA_PLUGGED,0);
      int resId;
      if (plugType == BatteryManager.BATTERY_PLUGGED_AC) {
        resId=R.string.power_charging_duration_ac;
      }
 else       if (plugType == BatteryManager.BATTERY_PLUGGED_USB) {
        resId=R.string.power_charging_duration_usb;
      }
 else       if (plugType == BatteryManager.BATTERY_PLUGGED_WIRELESS) {
        resId=R.string.power_charging_duration_wireless;
      }
 else {
        resId=R.string.power_charging_duration;
      }
      info.mChargeLabelString=context.getResources().getString(resId,batteryPercentString,timeString);
    }
 else {
      info.mChargeLabelString=context.getResources().getString(R.string.power_charging,batteryPercentString,statusLabel);
    }
  }
  return info;
}
