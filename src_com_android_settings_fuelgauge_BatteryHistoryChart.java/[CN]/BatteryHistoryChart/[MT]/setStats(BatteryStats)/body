{
  mStats=stats;
  long uSecTime=mStats.computeBatteryRealtime(SystemClock.elapsedRealtime() * 1000,BatteryStats.STATS_SINCE_CHARGED);
  mStatsPeriod=uSecTime;
  String durationString=Utils.formatElapsedTime(getContext(),mStatsPeriod / 1000);
  mDurationString=getContext().getString(R.string.battery_stats_on_battery,durationString);
  mChargingLabel=getContext().getString(R.string.battery_stats_charging_label);
  mScreenOnLabel=getContext().getString(R.string.battery_stats_screen_on_label);
  mGpsOnLabel=getContext().getString(R.string.battery_stats_gps_on_label);
  mWifiRunningLabel=getContext().getString(R.string.battery_stats_wifi_running_label);
  mWakeLockLabel=getContext().getString(R.string.battery_stats_wake_lock_label);
  mPhoneSignalLabel=getContext().getString(R.string.battery_stats_phone_signal_label);
  BatteryStats.HistoryItem rec=stats.getHistory();
  mHistFirst=null;
  int pos=0;
  int lastInteresting=0;
  byte lastLevel=-1;
  mBatLow=0;
  mBatHigh=100;
  int aggrStates=0;
  while (rec != null) {
    pos++;
    if (rec.cmd == HistoryItem.CMD_UPDATE) {
      if (mHistFirst == null) {
        mHistFirst=rec;
        mHistStart=rec.time;
      }
      if (rec.batteryLevel != lastLevel || pos == 1) {
        lastLevel=rec.batteryLevel;
        lastInteresting=pos;
        mHistEnd=rec.time;
      }
      aggrStates|=rec.states;
    }
    rec=rec.next;
  }
  mNumHist=lastInteresting;
  mHaveGps=(aggrStates & HistoryItem.STATE_GPS_ON_FLAG) != 0;
  mHaveWifi=(aggrStates & HistoryItem.STATE_WIFI_RUNNING_FLAG) != 0;
  if (mHistEnd <= mHistStart)   mHistEnd=mHistStart + 1;
  mTotalDurationString=Utils.formatElapsedTime(getContext(),mHistEnd - mHistStart);
}
