{
  mStats=stats;
  long uSecTime=mStats.computeBatteryRealtime(SystemClock.elapsedRealtime() * 1000,BatteryStats.STATS_SINCE_CHARGED);
  mStatsPeriod=uSecTime;
  String durationString=Utils.formatElapsedTime(getContext(),mStatsPeriod / 1000);
  mDurationString=getContext().getString(R.string.battery_stats_on_battery,durationString);
  mChargingLabel=getContext().getString(R.string.battery_stats_charging_label);
  mScreenOnLabel=getContext().getString(R.string.battery_stats_screen_on_label);
  mGpsOnLabel=getContext().getString(R.string.battery_stats_gps_on_label);
  mWifiRunningLabel=getContext().getString(R.string.battery_stats_wifi_running_label);
  mWakeLockLabel=getContext().getString(R.string.battery_stats_wake_lock_label);
  mPhoneSignalLabel=getContext().getString(R.string.battery_stats_phone_signal_label);
  int pos=0;
  int lastInteresting=0;
  byte lastLevel=-1;
  mBatLow=0;
  mBatHigh=100;
  int aggrStates=0;
  boolean first=true;
  if (stats.startIteratingHistoryLocked()) {
    final HistoryItem rec=new HistoryItem();
    while (stats.getNextHistoryLocked(rec)) {
      pos++;
      if (rec.cmd == HistoryItem.CMD_UPDATE) {
        if (first) {
          first=false;
          mHistStart=rec.time;
        }
        if (rec.batteryLevel != lastLevel || pos == 1) {
          lastLevel=rec.batteryLevel;
        }
        lastInteresting=pos;
        mHistEnd=rec.time;
        aggrStates|=rec.states;
      }
    }
  }
  mNumHist=lastInteresting;
  mHaveGps=(aggrStates & HistoryItem.STATE_GPS_ON_FLAG) != 0;
  mHaveWifi=(aggrStates & HistoryItem.STATE_WIFI_RUNNING_FLAG) != 0;
  if (!com.android.settings.Utils.isWifiOnly()) {
    mHavePhoneSignal=true;
  }
  if (mHistEnd <= mHistStart)   mHistEnd=mHistStart + 1;
  mTotalDurationString=Utils.formatElapsedTime(getContext(),mHistEnd - mHistStart);
}
