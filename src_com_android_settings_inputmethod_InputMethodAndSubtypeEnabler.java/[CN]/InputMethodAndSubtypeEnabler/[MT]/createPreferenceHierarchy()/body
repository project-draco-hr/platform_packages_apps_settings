{
  final PreferenceScreen root=getPreferenceManager().createPreferenceScreen(getActivity());
  final Context context=getActivity();
  int N=(mInputMethodProperties == null ? 0 : mInputMethodProperties.size());
  for (int i=0; i < N; ++i) {
    final InputMethodInfo imi=mInputMethodProperties.get(i);
    final int subtypeCount=imi.getSubtypeCount();
    if (subtypeCount <= 1)     continue;
    final String imiId=imi.getId();
    if (!TextUtils.isEmpty(mInputMethodId) && !mInputMethodId.equals(imiId)) {
      continue;
    }
    final PreferenceCategory keyboardSettingsCategory=new PreferenceCategory(context);
    root.addPreference(keyboardSettingsCategory);
    final PackageManager pm=getPackageManager();
    final CharSequence label=imi.loadLabel(pm);
    keyboardSettingsCategory.setTitle(label);
    keyboardSettingsCategory.setKey(imiId);
    final CheckBoxPreference autoCB=new CheckBoxPreference(context);
    mSubtypeAutoSelectionCBMap.put(imiId,autoCB);
    keyboardSettingsCategory.addPreference(autoCB);
    final PreferenceCategory activeInputMethodsCategory=new PreferenceCategory(context);
    activeInputMethodsCategory.setTitle(R.string.active_input_method_subtypes);
    root.addPreference(activeInputMethodsCategory);
    boolean isAutoSubtype=false;
    CharSequence autoSubtypeLabel=null;
    final ArrayList<Preference> subtypePreferences=new ArrayList<Preference>();
    if (subtypeCount > 0) {
      for (int j=0; j < subtypeCount; ++j) {
        final InputMethodSubtype subtype=imi.getSubtypeAt(j);
        final CharSequence subtypeLabel=subtype.getDisplayName(context,imi.getPackageName(),imi.getServiceInfo().applicationInfo);
        if (subtype.overridesImplicitlyEnabledSubtype()) {
          if (!isAutoSubtype) {
            isAutoSubtype=true;
            autoSubtypeLabel=subtypeLabel;
          }
        }
 else {
          final CheckBoxPreference chkbxPref=new SubtypeCheckBoxPreference(context,subtype.getLocale(),mSystemLocale,mCollator);
          chkbxPref.setKey(imiId + subtype.hashCode());
          chkbxPref.setTitle(subtypeLabel);
          subtypePreferences.add(chkbxPref);
        }
      }
      Collections.sort(subtypePreferences);
      for (int j=0; j < subtypePreferences.size(); ++j) {
        activeInputMethodsCategory.addPreference(subtypePreferences.get(j));
      }
      mInputMethodAndSubtypePrefsMap.put(imiId,subtypePreferences);
    }
    if (isAutoSubtype) {
      if (TextUtils.isEmpty(autoSubtypeLabel)) {
        Log.w(TAG,"Title for auto subtype is empty.");
        autoCB.setTitle("---");
      }
 else {
        autoCB.setTitle(autoSubtypeLabel);
      }
    }
 else {
      autoCB.setTitle(R.string.use_system_language_to_select_input_method_subtypes);
    }
  }
  return root;
}
