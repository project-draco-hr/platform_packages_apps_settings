{
  if (preference instanceof CheckBoxPreference) {
    final CheckBoxPreference chkPref=(CheckBoxPreference)preference;
    for (    String imiId : mSubtypeAutoSelectionCBMap.keySet()) {
      if (mSubtypeAutoSelectionCBMap.get(imiId) == chkPref) {
        setSubtypeAutoSelectionEnabled(imiId,chkPref.isChecked());
        return super.onPreferenceTreeClick(preferenceScreen,preference);
      }
    }
    final String id=chkPref.getKey();
    if (chkPref.isChecked()) {
      InputMethodInfo selImi=null;
      final int N=mInputMethodProperties.size();
      for (int i=0; i < N; i++) {
        InputMethodInfo imi=mInputMethodProperties.get(i);
        if (id.equals(imi.getId())) {
          selImi=imi;
          if (InputMethodAndSubtypeUtil.isSystemIme(imi)) {
            InputMethodAndSubtypeUtil.setSubtypesPreferenceEnabled(this,mInputMethodProperties,id,true);
            return super.onPreferenceTreeClick(preferenceScreen,preference);
          }
          break;
        }
      }
      if (selImi == null) {
        return super.onPreferenceTreeClick(preferenceScreen,preference);
      }
      chkPref.setChecked(false);
      if (mDialog == null) {
        mDialog=(new AlertDialog.Builder(getActivity())).setTitle(android.R.string.dialog_alert_title).setIconAttribute(android.R.attr.alertDialogIcon).setCancelable(true).setPositiveButton(android.R.string.ok,new DialogInterface.OnClickListener(){
          @Override public void onClick(          DialogInterface dialog,          int which){
            chkPref.setChecked(true);
            InputMethodAndSubtypeUtil.setSubtypesPreferenceEnabled(InputMethodAndSubtypeEnabler.this,mInputMethodProperties,id,true);
          }
        }
).setNegativeButton(android.R.string.cancel,new DialogInterface.OnClickListener(){
          @Override public void onClick(          DialogInterface dialog,          int which){
          }
        }
).create();
      }
 else {
        if (mDialog.isShowing()) {
          mDialog.dismiss();
        }
      }
      mDialog.setMessage(getResources().getString(R.string.ime_security_warning,selImi.getServiceInfo().applicationInfo.loadLabel(getPackageManager())));
      mDialog.show();
    }
 else {
      InputMethodAndSubtypeUtil.setSubtypesPreferenceEnabled(this,mInputMethodProperties,id,false);
      updateAutoSelectionCB();
    }
  }
  return super.onPreferenceTreeClick(preferenceScreen,preference);
}
