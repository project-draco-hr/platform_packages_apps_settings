{
  super.onActivityCreated(savedInstanceState);
  mContext=getActivity();
  mPM=mContext.getPackageManager();
  final Resources res=mContext.getResources();
  final int p=res.getDimensionPixelSize(R.dimen.content_margin_left);
  addPreferencesFromResource(R.xml.zen_mode_settings);
  final PreferenceScreen root=getPreferenceScreen();
  mConfig=getZenModeConfig();
  if (DEBUG)   Log.d(TAG,"Loaded mConfig=" + mConfig);
  mSwitchBar=((SettingsActivity)mContext).getSwitchBar();
  mSwitch=mSwitchBar.getSwitch();
  final PreferenceCategory general=(PreferenceCategory)root.findPreference(KEY_GENERAL);
  mCalls=(SwitchPreference)general.findPreference(KEY_CALLS);
  if (Utils.isVoiceCapable(mContext)) {
    mCalls.setOnPreferenceChangeListener(new OnPreferenceChangeListener(){
      @Override public boolean onPreferenceChange(      Preference preference,      Object newValue){
        if (mDisableListeners)         return true;
        final boolean val=(Boolean)newValue;
        if (val == mConfig.allowCalls)         return true;
        if (DEBUG)         Log.d(TAG,"onPrefChange allowCalls=" + val);
        final ZenModeConfig newConfig=mConfig.copy();
        newConfig.allowCalls=val;
        return setZenModeConfig(newConfig);
      }
    }
);
  }
 else {
    general.removePreference(mCalls);
    mCalls=null;
  }
  mMessages=(SwitchPreference)general.findPreference(KEY_MESSAGES);
  mMessages.setOnPreferenceChangeListener(new OnPreferenceChangeListener(){
    @Override public boolean onPreferenceChange(    Preference preference,    Object newValue){
      if (mDisableListeners)       return true;
      final boolean val=(Boolean)newValue;
      if (val == mConfig.allowMessages)       return true;
      if (DEBUG)       Log.d(TAG,"onPrefChange allowMessages=" + val);
      final ZenModeConfig newConfig=mConfig.copy();
      newConfig.allowMessages=val;
      return setZenModeConfig(newConfig);
    }
  }
);
  mStarred=new DropDownPreference(mContext);
  mStarred.setEnabled(false);
  mStarred.setTitle(R.string.zen_mode_from);
  mStarred.setDropDownWidth(R.dimen.zen_mode_dropdown_width);
  mStarred.addItem(R.string.zen_mode_from_anyone,null);
  mStarred.addItem(R.string.zen_mode_from_starred,null);
  mStarred.addItem(R.string.zen_mode_from_contacts,null);
  general.addPreference(mStarred);
  final Preference alarmInfo=new Preference(mContext){
    @Override public View getView(    View convertView,    ViewGroup parent){
      final TextView tv=new TextView(mContext);
      tv.setTypeface(Typeface.create(Typeface.DEFAULT,Typeface.ITALIC));
      tv.setPadding(p,p,p,p);
      tv.setText(R.string.zen_mode_alarm_info);
      return tv;
    }
  }
;
  alarmInfo.setPersistent(false);
  alarmInfo.setSelectable(false);
  general.addPreference(alarmInfo);
  final PreferenceCategory auto=(PreferenceCategory)root.findPreference(KEY_AUTOMATIC);
  mWhen=new DropDownPreference(mContext);
  mWhen.setKey(KEY_WHEN);
  mWhen.setTitle(R.string.zen_mode_when);
  mWhen.setDropDownWidth(R.dimen.zen_mode_dropdown_width);
  mWhen.addItem(R.string.zen_mode_when_every_night,ZenModeConfig.SLEEP_MODE_NIGHTS);
  mWhen.addItem(R.string.zen_mode_when_weeknights,ZenModeConfig.SLEEP_MODE_WEEKNIGHTS);
  mWhen.addItem(R.string.zen_mode_when_never,null);
  mWhen.setCallback(new DropDownPreference.Callback(){
    @Override public boolean onItemSelected(    int pos,    Object value){
      if (mDisableListeners)       return true;
      final String mode=(String)value;
      if (Objects.equals(mode,mConfig.sleepMode))       return true;
      if (DEBUG)       Log.d(TAG,"onPrefChange sleepMode=" + mode);
      final ZenModeConfig newConfig=mConfig.copy();
      newConfig.sleepMode=mode;
      return setZenModeConfig(newConfig);
    }
  }
);
  auto.addPreference(mWhen);
  final FragmentManager mgr=getFragmentManager();
  mStart=new TimePickerPreference(mContext,mgr);
  mStart.setKey(KEY_START_TIME);
  mStart.setTitle(R.string.zen_mode_start_time);
  mStart.setCallback(new TimePickerPreference.Callback(){
    @Override public boolean onSetTime(    int hour,    int minute){
      if (mDisableListeners)       return true;
      if (!ZenModeConfig.isValidHour(hour))       return false;
      if (!ZenModeConfig.isValidMinute(minute))       return false;
      if (hour == mConfig.sleepStartHour && minute == mConfig.sleepStartMinute) {
        return true;
      }
      if (DEBUG)       Log.d(TAG,"onPrefChange sleepStart h=" + hour + " m="+ minute);
      final ZenModeConfig newConfig=mConfig.copy();
      newConfig.sleepStartHour=hour;
      newConfig.sleepStartMinute=minute;
      return setZenModeConfig(newConfig);
    }
  }
);
  auto.addPreference(mStart);
  mStart.setDependency(mWhen.getKey());
  mEnd=new TimePickerPreference(mContext,mgr);
  mEnd.setKey(KEY_END_TIME);
  mEnd.setTitle(R.string.zen_mode_end_time);
  mEnd.setSummaryFormat(R.string.zen_mode_end_time_summary_format);
  mEnd.setCallback(new TimePickerPreference.Callback(){
    @Override public boolean onSetTime(    int hour,    int minute){
      if (mDisableListeners)       return true;
      if (!ZenModeConfig.isValidHour(hour))       return false;
      if (!ZenModeConfig.isValidMinute(minute))       return false;
      if (hour == mConfig.sleepEndHour && minute == mConfig.sleepEndMinute) {
        return true;
      }
      if (DEBUG)       Log.d(TAG,"onPrefChange sleepEnd h=" + hour + " m="+ minute);
      final ZenModeConfig newConfig=mConfig.copy();
      newConfig.sleepEndHour=hour;
      newConfig.sleepEndMinute=minute;
      return setZenModeConfig(newConfig);
    }
  }
);
  auto.addPreference(mEnd);
  mEnd.setDependency(mWhen.getKey());
  mAutomationCategory=(PreferenceCategory)findPreference(KEY_AUTOMATION);
  mEntry=findPreference(KEY_ENTRY);
  mEntry.setOnPreferenceClickListener(new OnPreferenceClickListener(){
    @Override public boolean onPreferenceClick(    Preference preference){
      new AlertDialog.Builder(mContext).setTitle(R.string.zen_mode_entry_conditions_title).setView(new ZenModeAutomaticConditionSelection(mContext)).setOnDismissListener(new OnDismissListener(){
        @Override public void onDismiss(        DialogInterface dialog){
          refreshAutomationSection();
        }
      }
).setPositiveButton(R.string.dlg_ok,null).show();
      return true;
    }
  }
);
  mConditionProviders=findPreference(KEY_CONDITION_PROVIDERS);
  updateZenMode();
  updateControls();
}
