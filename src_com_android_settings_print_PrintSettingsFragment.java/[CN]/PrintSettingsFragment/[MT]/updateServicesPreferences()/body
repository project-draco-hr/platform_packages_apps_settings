{
  if (getPreferenceScreen().findPreference(PRINT_SERVICES_CATEGORY) == null) {
    getPreferenceScreen().addPreference(mPrintServicesCategory);
  }
 else {
    mPrintServicesCategory.removeAll();
  }
  List<ComponentName> enabledServices=PrintSettingsUtils.readEnabledPrintServices(getActivity());
  List<ResolveInfo> installedServices=getActivity().getPackageManager().queryIntentServices(new Intent(android.printservice.PrintService.SERVICE_INTERFACE),PackageManager.GET_SERVICES | PackageManager.GET_META_DATA);
  final int installedServiceCount=installedServices.size();
  for (int i=0; i < installedServiceCount; i++) {
    ResolveInfo installedService=installedServices.get(i);
    PreferenceScreen preference=getPreferenceManager().createPreferenceScreen(getActivity());
    String title=installedService.loadLabel(getPackageManager()).toString();
    preference.setTitle(title);
    ComponentName componentName=new ComponentName(installedService.serviceInfo.packageName,installedService.serviceInfo.name);
    preference.setKey(componentName.flattenToString());
    preference.setOrder(i);
    preference.setFragment(PrintServiceSettingsFragment.class.getName());
    preference.setPersistent(false);
    final boolean serviceEnabled=enabledServices.contains(componentName);
    if (serviceEnabled) {
      preference.setSummary(getString(R.string.print_feature_state_on));
    }
 else {
      preference.setSummary(getString(R.string.print_feature_state_off));
    }
    Bundle extras=preference.getExtras();
    extras.putString(EXTRA_PREFERENCE_KEY,preference.getKey());
    extras.putBoolean(EXTRA_CHECKED,serviceEnabled);
    extras.putString(EXTRA_TITLE,title);
    PrintServiceInfo printServiceInfo=PrintServiceInfo.create(installedService,getActivity());
    CharSequence applicationLabel=installedService.loadLabel(getPackageManager());
    extras.putString(EXTRA_ENABLE_WARNING_TITLE,getString(R.string.print_service_security_warning_title,applicationLabel));
    extras.putString(EXTRA_ENABLE_WARNING_MESSAGE,getString(R.string.print_service_security_warning_summary,applicationLabel));
    String settingsClassName=printServiceInfo.getSettingsActivityName();
    if (!TextUtils.isEmpty(settingsClassName)) {
      extras.putString(EXTRA_SETTINGS_TITLE,getString(R.string.print_menu_item_settings));
      extras.putString(EXTRA_SETTINGS_COMPONENT_NAME,new ComponentName(installedService.serviceInfo.packageName,settingsClassName).flattenToString());
    }
    String addPrinterClassName=printServiceInfo.getAddPrintersActivityName();
    if (!TextUtils.isEmpty(addPrinterClassName)) {
      extras.putString(EXTRA_ADD_PRINTERS_TITLE,getString(R.string.print_menu_item_add_printers));
      extras.putString(EXTRA_ADD_PRINTERS_COMPONENT_NAME,new ComponentName(installedService.serviceInfo.packageName,addPrinterClassName).flattenToString());
    }
    extras.putString(EXTRA_SERVICE_COMPONENT_NAME,componentName.flattenToString());
    mPrintServicesCategory.addPreference(preference);
  }
  if (mPrintServicesCategory.getPreferenceCount() == 0) {
    getPreferenceScreen().removePreference(mPrintServicesCategory);
  }
}
