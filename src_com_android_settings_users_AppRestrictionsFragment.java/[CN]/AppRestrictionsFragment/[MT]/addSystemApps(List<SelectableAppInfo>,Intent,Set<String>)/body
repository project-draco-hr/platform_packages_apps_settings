{
  if (getActivity() == null)   return;
  final PackageManager pm=mPackageManager;
  List<ResolveInfo> launchableApps=pm.queryIntentActivities(intent,PackageManager.GET_DISABLED_COMPONENTS | PackageManager.GET_UNINSTALLED_PACKAGES);
  for (  ResolveInfo app : launchableApps) {
    if (app.activityInfo != null && app.activityInfo.applicationInfo != null) {
      final String packageName=app.activityInfo.packageName;
      int flags=app.activityInfo.applicationInfo.flags;
      if ((flags & ApplicationInfo.FLAG_SYSTEM) != 0 || (flags & ApplicationInfo.FLAG_UPDATED_SYSTEM_APP) != 0) {
        if (excludePackages.contains(packageName))         continue;
        int enabled=pm.getApplicationEnabledSetting(packageName);
        if (enabled == PackageManager.COMPONENT_ENABLED_STATE_DISABLED_UNTIL_USED || enabled == PackageManager.COMPONENT_ENABLED_STATE_DISABLED) {
          ApplicationInfo targetUserAppInfo=getAppInfoForUser(packageName,0,mUser);
          if (targetUserAppInfo == null || (targetUserAppInfo.flags & ApplicationInfo.FLAG_INSTALLED) == 0) {
            continue;
          }
        }
        SelectableAppInfo info=new SelectableAppInfo();
        info.packageName=app.activityInfo.packageName;
        info.appName=app.activityInfo.applicationInfo.loadLabel(pm);
        info.icon=app.activityInfo.loadIcon(pm);
        info.activityName=app.activityInfo.loadLabel(pm);
        if (info.activityName == null)         info.activityName=info.appName;
        visibleApps.add(info);
      }
    }
  }
}
