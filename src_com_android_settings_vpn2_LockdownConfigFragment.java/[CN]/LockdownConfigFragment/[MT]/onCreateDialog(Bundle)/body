{
  final Context context=getActivity();
  final KeyStore keyStore=KeyStore.getInstance();
  initProfiles(keyStore,context.getResources());
  final AlertDialog.Builder builder=new AlertDialog.Builder(context);
  final LayoutInflater dialogInflater=LayoutInflater.from(builder.getContext());
  builder.setTitle(R.string.vpn_menu_lockdown);
  final View view=dialogInflater.inflate(R.layout.vpn_lockdown_editor,null,false);
  final ListView listView=(ListView)view.findViewById(android.R.id.list);
  listView.setChoiceMode(ListView.CHOICE_MODE_SINGLE);
  listView.setAdapter(new TitleAdapter(context,mTitles));
  listView.setItemChecked(mCurrentIndex,true);
  builder.setView(view);
  builder.setPositiveButton(android.R.string.ok,new DialogInterface.OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      final int newIndex=listView.getCheckedItemPosition();
      if (mCurrentIndex == newIndex)       return;
      if (newIndex == 0) {
        keyStore.delete(Credentials.LOCKDOWN_VPN);
      }
 else {
        final VpnProfile profile=mProfiles.get(newIndex - 1);
        if (!profile.isValidLockdownProfile()) {
          Toast.makeText(context,R.string.vpn_lockdown_config_error,Toast.LENGTH_LONG).show();
          return;
        }
        keyStore.put(Credentials.LOCKDOWN_VPN,profile.key.getBytes(),KeyStore.UID_SELF,0);
      }
      ConnectivityManager.from(getActivity()).updateLockdownVpn();
    }
  }
);
  return builder.create();
}
