{
  super.onResume();
  if (mKeyStore.state() != KeyStore.State.UNLOCKED) {
    if (!mUnlocking) {
      Credentials.getInstance().unlock(getActivity());
    }
 else {
      finishFragment();
    }
    mUnlocking=!mUnlocking;
    return;
  }
  mUnlocking=false;
  if (mPreferences == null) {
    mPreferences=new HashMap<String,VpnPreference>();
    PreferenceGroup group=getPreferenceScreen();
    final Context context=getActivity();
    final List<VpnProfile> profiles=loadVpnProfiles(mKeyStore);
    for (    VpnProfile profile : profiles) {
      final VpnPreference pref=new VpnPreference(context,profile);
      pref.setOnPreferenceClickListener(this);
      mPreferences.put(profile.key,pref);
      group.addPreference(pref);
    }
  }
  if (mDialog != null) {
    mDialog.setOnDismissListener(this);
    mDialog.show();
  }
  if (mUpdater == null) {
    mUpdater=new Handler(this);
  }
  mUpdater.sendEmptyMessage(0);
  registerForContextMenu(getListView());
}
