{
  boolean secretMissing=false;
  if (p instanceof L2tpIpsecProfile) {
    L2tpIpsecProfile certProfile=(L2tpIpsecProfile)p;
    String cert=certProfile.getCaCertificate();
    if (TextUtils.isEmpty(cert) || !mKeyStore.contains(Credentials.CA_CERTIFICATE + cert)) {
      certProfile.setCaCertificate(null);
      secretMissing=true;
    }
    cert=certProfile.getUserCertificate();
    if (TextUtils.isEmpty(cert) || !mKeyStore.contains(Credentials.USER_CERTIFICATE + cert)) {
      certProfile.setUserCertificate(null);
      secretMissing=true;
    }
  }
  if (p instanceof L2tpIpsecPskProfile) {
    L2tpIpsecPskProfile pskProfile=(L2tpIpsecPskProfile)p;
    String presharedKey=pskProfile.getPresharedKey();
    String key=KEY_PREFIX_IPSEC_PSK + p.getId();
    if (TextUtils.isEmpty(presharedKey) || !mKeyStore.contains(key)) {
      pskProfile.setPresharedKey(null);
      secretMissing=true;
    }
  }
  if (p instanceof L2tpProfile) {
    L2tpProfile l2tpProfile=(L2tpProfile)p;
    if (l2tpProfile.isSecretEnabled()) {
      String secret=l2tpProfile.getSecretString();
      String key=KEY_PREFIX_L2TP_SECRET + p.getId();
      if (TextUtils.isEmpty(secret) || !mKeyStore.contains(key)) {
        l2tpProfile.setSecretString(null);
        secretMissing=true;
      }
    }
  }
  if (secretMissing) {
    mActiveProfile=p;
    showDialog(DIALOG_SECRET_NOT_SET);
    return false;
  }
 else {
    return true;
  }
}
