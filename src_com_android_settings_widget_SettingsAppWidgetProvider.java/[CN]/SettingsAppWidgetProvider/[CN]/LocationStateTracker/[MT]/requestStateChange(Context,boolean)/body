{
  final ContentResolver resolver=context.getContentResolver();
  new AsyncTask<Void,Void,Boolean>(){
    @Override protected Boolean doInBackground(    Void... args){
      final UserManager um=(UserManager)context.getSystemService(Context.USER_SERVICE);
      if (!um.hasUserRestriction(UserManager.DISALLOW_SHARE_LOCATION)) {
        int mode=desiredState ? Settings.Secure.LOCATION_MODE_HIGH_ACCURACY : Settings.Secure.LOCATION_MODE_BATTERY_SAVING;
        Settings.Secure.putInt(resolver,Settings.Secure.LOCATION_MODE,mode);
        return desiredState;
      }
      return getActualState(context) == STATE_ENABLED;
    }
    @Override protected void onPostExecute(    Boolean result){
      setCurrentState(context,result ? STATE_ENABLED : STATE_DISABLED);
      updateWidget(context);
    }
  }
.execute();
}
