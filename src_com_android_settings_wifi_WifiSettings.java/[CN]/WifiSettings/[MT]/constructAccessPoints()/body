{
  ArrayList<AccessPoint> accessPoints=new ArrayList<AccessPoint>();
  Multimap<String,AccessPoint> apMap=new Multimap<String,AccessPoint>();
  final List<WifiConfiguration> configs=mWifiManager.getConfiguredNetworks();
  if (configs != null) {
    for (    WifiConfiguration config : configs) {
      AccessPoint accessPoint=new AccessPoint(getActivity(),config);
      accessPoint.update(mLastInfo,mLastState);
      accessPoints.add(accessPoint);
      apMap.put(accessPoint.ssid,accessPoint);
    }
  }
  final List<ScanResult> results=mWifiManager.getScanResults();
  if (results != null) {
    for (    ScanResult result : results) {
      if (result.SSID == null || result.SSID.length() == 0 || result.capabilities.contains("[IBSS]")) {
        continue;
      }
      boolean found=false;
      if (apMap.getAll(result.SSID) != null) {
        for (        AccessPoint accessPoint : apMap.getAll(result.SSID)) {
          if (accessPoint.update(result))           found=true;
        }
      }
      if (!found) {
        AccessPoint accessPoint=new AccessPoint(getActivity(),result);
        accessPoints.add(accessPoint);
        apMap.put(accessPoint.ssid,accessPoint);
      }
    }
  }
  Collections.sort(accessPoints);
  return accessPoints;
}
