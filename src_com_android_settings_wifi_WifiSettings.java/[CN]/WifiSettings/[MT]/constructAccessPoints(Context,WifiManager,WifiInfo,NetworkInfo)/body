{
  ArrayList<AccessPoint> accessPoints=new ArrayList<AccessPoint>();
  Multimap<String,AccessPoint> apMap=new Multimap<String,AccessPoint>();
  WifiConfiguration connectionConfig=null;
  final List<WifiConfiguration> configs=wifiManager.getConfiguredNetworks();
  if (configs != null) {
    if (savedNetworksExist != (configs.size() > 0)) {
      savedNetworksExist=!savedNetworksExist;
      if (context instanceof Activity) {
        ((Activity)context).invalidateOptionsMenu();
      }
    }
    for (    WifiConfiguration config : configs) {
      if (lastInfo != null && lastInfo.getNetworkId() == config.networkId) {
        connectionConfig=config;
      }
      if (config.selfAdded && config.numAssociation == 0) {
        continue;
      }
      if (config.isPasspoint()) {
        continue;
      }
      AccessPoint accessPoint=new AccessPoint(context,config);
      if (lastInfo != null && lastNetworkInfo != null) {
        accessPoint.update(lastInfo,lastNetworkInfo);
      }
      accessPoints.add(accessPoint);
      apMap.put(accessPoint.ssid,accessPoint);
    }
  }
  final List<ScanResult> results=wifiManager.getScanResults();
  if (results != null) {
    for (    ScanResult result : results) {
      if (result.SSID == null || result.SSID.length() == 0 || result.capabilities.contains("[IBSS]")) {
        continue;
      }
      boolean found=false;
      for (      AccessPoint accessPoint : apMap.getAll(result.SSID)) {
        if (accessPoint.update(result))         found=true;
      }
      if (!found) {
        AccessPoint accessPoint=new AccessPoint(context,result);
        if (lastInfo != null && lastNetworkInfo != null) {
          accessPoint.update(lastInfo,lastNetworkInfo);
        }
        if (result.passpointNetwork) {
          WifiConfiguration config=wifiManager.getMatchingWifiConfig(result);
          if (config != null) {
            accessPoint.update(config);
          }
        }
        if (lastInfo != null && lastInfo.getBSSID() != null && lastInfo.getBSSID().equals(result.BSSID) && connectionConfig != null && connectionConfig.isPasspoint()) {
          accessPoint.update(connectionConfig);
        }
        accessPoints.add(accessPoint);
        apMap.put(accessPoint.ssid,accessPoint);
      }
    }
  }
  Collections.sort(accessPoints);
  return accessPoints;
}
