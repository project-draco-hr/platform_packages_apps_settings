{
  super.onCreate(icicle);
  addPreferencesFromResource(R.xml.wifi_p2p_settings);
  mIntentFilter.addAction(WifiP2pManager.WIFI_P2P_STATE_CHANGED_ACTION);
  mIntentFilter.addAction(WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION);
  mIntentFilter.addAction(WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION);
  final Activity activity=getActivity();
  mWifiP2pManager=(WifiP2pManager)getSystemService(Context.WIFI_P2P_SERVICE);
  if (mWifiP2pManager != null) {
    mChannel=mWifiP2pManager.initialize(activity,getActivity().getMainLooper(),null);
    if (mChannel == null) {
      Log.e(TAG,"Failed to set up connection with wifi p2p service");
      mWifiP2pManager=null;
    }
  }
 else {
    Log.e(TAG,"mWifiP2pManager is null !");
  }
  mConnectListener=new OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      if (which == DialogInterface.BUTTON_POSITIVE) {
        WifiP2pConfig config=mConnectDialog.getConfig();
        if (mWifiP2pManager != null) {
          mWifiP2pManager.connect(mChannel,config,new WifiP2pManager.ActionListener(){
            public void onSuccess(){
              Log.d(TAG," connect success");
            }
            public void onFailure(            int reason){
              Log.d(TAG," connect fail " + reason);
            }
          }
);
        }
      }
    }
  }
;
  mDisconnectListener=new OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      if (which == DialogInterface.BUTTON_POSITIVE) {
        if (mWifiP2pManager != null) {
          mWifiP2pManager.removeGroup(mChannel,new WifiP2pManager.ActionListener(){
            public void onSuccess(){
              Log.d(TAG," remove group success");
            }
            public void onFailure(            int reason){
              Log.d(TAG," remove group fail " + reason);
            }
          }
);
        }
      }
    }
  }
;
  setHasOptionsMenu(true);
}
